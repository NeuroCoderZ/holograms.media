# Актуальный Контекст Проекта Holograms Media (v29.0) - Обновлено: 2025-05-19

## 0. Важная Информация для AI
- **Основной документ:** Системная Инструкция (текущая версия v29.0+).
- **Этот файл (`PROJECT_CONTEXT.md`):** Актуальный срез состояния, цели, ключевые файлы, проблемы. AI ОБЯЗАН ознакомиться перед каждой задачей.
- **Лог итераций:** `@tria_memory_buffer.md`.

## 1. Обзор и Цели Проекта
- **Имя:** holograms.media
- **Репозиторий:** `https://github.com/NeuroCoderZ/holograms.media`
- **Миссия:** R&D платформа для создания интерактивных 3D-аудиовизуализаций ("голограмм") с AI "Триа", стремящаяся к новому языку коммуникации. Преодоление симуляционно-реального разрыва через обучение Триа на "комбинированных аудио(видео)-чанках".
- **Лицензия:** MIT.
- **Системная Инструкция:** v29.0 (основной источник архитектуры и философии).

## 2. Ключевые Технологии (Целевые)
- **Backend:** Python 3.12+, FastAPI, Uvicorn, **PostgreSQL + `pgvector` (драйвер `asyncpg`)**.
- **Frontend:** JavaScript (ES6 Modules), Three.js (r128+), **WebGPU (цель)**, WebRTC, Web Audio API, MediaPipe Hands.
- **AI "Триа":** Сеть ботов (Аудио, Жесты, Память, Обучение), LangChain, RAG, Continual Learning, UMAP, Генетические алгоритмы.
- **Развертывание:** Hugging Face Spaces (Docker).
- **CI/CD:** GitHub Actions.

## 3. Структура Проекта и Ключевые Файлы
- **`backend/app.py`**: Основной файл FastAPI бэкенда.
- **`backend/requirements.txt`**: Зависимости Python.
- **`backend/tria_bots/`**: Директория для модулей ботов Триа (пока заглушки).
- **`frontend/index.html`**: Главный HTML.
- **`frontend/js/main.js`**: Точка входа и оркестратор ES6 модулей фронтенда.
- **`frontend/js/core/init.js`**: Инициализация глобального `state`.
- **`frontend/js/3d/sceneSetup.js`**: Инициализация 3D-сцены (Three.js/WebGPU).
- **`frontend/js/3d/rendering.js`**: Логика рендеринга аудиовизуализации.
- **`frontend/js/audio/`**: Модули для аудио (`microphoneManager.js`, `audioFilePlayer.js`, `speechInput.js`).
- **`frontend/js/ui/`**: Модули UI (`uiManager.js`, `panelManager.js`, `layoutManager.js`).
- **`frontend/js/core/`**: Ядро фронтенда (`events.js`, `diagnostics.js`, `resizeHandler.js`, `domEventHandlers.js`).
- **`frontend/js/xr/`**: Модули для XR и камеры (`cameraManager.js`).
- **`frontend/js/multimodal/`**: Модули для мультимодального ввода (например, `handsTracking.js`).
frontend/script.js: (УДАЛЕН) Устаревший монолитный JS файл, функционал перенесен в модули в frontend/js/.
- **`Dockerfile`**: Конфигурация Docker для HF Spaces (пути к `backend/app.py` и `backend/requirements.txt` должны быть верны).
- **`PROJECT_CONTEXT.md`**: Этот файл.
- **`tria_memory_buffer.md`**: Лог итераций.
- **`ARCHITECTURE.md`**: Описание архитектуры потоков данных и Триа.
- **Последние Изменения:**
    - [2025-05-20] Устранены ошибка импорта chatMessages.js в main.js. Дублирующийся экспорт `initializeScene` в `sceneSetup.js` не обнаружен.
    - [ДАТА] Оптимизирован порядок инициализации в main.js.
    - [2025-05-21] Исправлен путь импорта chatMessages.js в main.js.
    - [2025-05-21] Устранены дубликаты файлов chatMessages.js и handsTracking.js. Файлы перемещены в корректные логические подпапки (`panels/` и `multimodal/`).
- [2025-05-21] Модули chat.js и rendering.js перемещены в корректные логические подпапки (`ai/` и `3d/`).
- [2025-05-21] Логика сохранения/загрузки состояния панелей вынесена из uiManager.js в appStatePersistence.js.
- [2025-05-21] Проверена корректность путей импорта для перемещенных модулей chatMessages.js, chat.js и handsTracking.js.
- [2025-05-21] Запущен локальный бэкенд сервер для тестирования фронтенда.

## 4. Текущий Фокус Разработки (2025-05-21)
1.  **Унификация управления состоянием:** Стандартизация подхода к управлению состоянием между модулями, устранение смешения глобального и локального состояния.
2.  **Оптимизация порядка инициализации компонентов:** Анализ и реструктуризация порядка загрузки и инициализации модулей в main.js.
3.  **Разделение UI и бизнес-логики:** Рефакторинг модулей для четкого разделения ответственности.
4. **Локальное тестирование фронтенда:** Проверка устранения ошибок 404 и ESLint, выявление оставшихся проблем интеграции модулей.
5. Подготовка к миграции бэкенда на PostgreSQL: Анализ `backend/app.py`, проектирование схемы БД.

## 5. Последние Ключевые Изменения (Хронология)
- **[2025-05-20]** Удалено подключение устаревшего script.js из index.html.
- **[2025-05-20]** Завершена полная очистка и удаление `frontend/script.js`. Вся логика перенесена в ES6 модули.
- **[2025-05-19]** Исправлен `Dockerfile` для корректной работы с новой структурой бэкенда (`backend/app.py`, `backend/requirements.txt`). (Коммит cc95d26)
- **[2025-05-18]** Реструктуризация папки `backend/`: `app.py`, `requirements.txt` перемещены в `backend/`, создана папка `backend/tests/` и `backend/tria_bots/`. Удалены старые бэкапы и `Jenkinsfile`. (Коммит af92652)
- **[2025-05-18]** Устранены ошибки дублирования объявлений для `createSphere/Line/Axis/Grid` в `script.js`. (Коммит 24e120e)
- **[2025-05-18]** Логика MediaPipe Hands перенесена из `script.js` в `handsTracking.js`, обновлен `main.js`. (Коммит 4cd726a)
- [ДАТА] Проведен рефакторинг управления состоянием фронтенда, ключевые переменные модулей перенесены в глобальный state.
- [2025-05-20] Исправлены ошибка 404 для chatMessages.js и SyntaxError для THREE в sceneSetup.js.
- [ДАТА] Исправлен импорт chatMessages.js. Начато разделение UI/логики в uiManager.js.
- [2025-05-21] Проведен анализ uiManager.js и events.js на предмет смешения UI/бизнес-логики. Текущая структура признана соответствующей принципам разделения ответственности на уровне обработчиков событий.
- [2025-05-21] Устранены SyntaxError в sceneSetup.js (некорректное имя импортируемой функции в init.js), ошибка 404 при импорте chatMessages.js в main.js (неверный путь импорта), дублирующиеся экспорты в uiManager.js и gestureAreaVisualization.js, а также некорректный путь импорта и неиспользуемые параметры в sceneSetup.js.
- [2025-05-21] Подтверждено отсутствие ссылок на устаревший script.js в index.html.
- [2025-05-21] Устранены синтаксическая ошибка в sceneSetup.js, ошибки 'Export not defined' в microphoneManager.js и mainUI.js, дублирующийся экспорт в uiManager.js и неиспользуемые переменные в rendering.js и gestureAreaVisualization.js.
- [2025-05-21] Проведен анализ и частичное устранение проблем с отсутствующими импортами в main.js, созданы заглушки для storage.js и helpers.js.
- *Более ранние изменения см. в `tria_memory_buffer.md` или истории коммитов.*

## 6. Критические Известные Проблемы и Блокеры (2025-05-21)
// Устаревший файл `frontend/script.js` полностью рефакторингован и удален.
- Неконсистентное управление состоянием во фронтенде (смешение глобального `state` и локальных переменных в модулях). **ПРОГРЕСС: Выполнена унификация, ключевые состояния модулей handsTracking, audioFilePlayer, microphoneManager перенесены в глобальный state.**
- **Проблемы с инициализацией компонентов:** Неоптимальный порядок инициализации в main.js, возможные зависимости между модулями, которые не отражены в порядке загрузки. (Частично решено устранением ошибок импорта и дубликатов)
- **Смешение UI и бизнес-логики:** В некоторых модулях (например, uiManager.js) смешаны функции управления DOM и бизнес-логика. **ПРОГРЕСС: Логика сохранения/загрузки состояния панелей полностью перенесена из uiManager.js в appStatePersistence.js.**
- **Отсутствующие модули и зависимости:** В main.js проанализированы закомментированные импорты, созданы заглушки для storage.js и helpers.js. Некоторые модули все еще отсутствуют (например, legacy-bridge.js, audio processing/visualization, gesture detection), их импорты оставлены закомментированными с TODO.
- **Безопасность API ключей в бэкенде:** API ключи (MISTRAL_API_KEY, CODESTRAL_API_KEY) загружаются из переменных окружения, но требуется дополнительная проверка безопасности.

## 7. Планы по AI "Триа" и PostgreSQL
- После стабилизации фронтенда начнется активная работа по миграции бэкенда на PostgreSQL с `pgvector`.
- Затем – реализация логики ботов Триа в `backend/tria_bots/`.