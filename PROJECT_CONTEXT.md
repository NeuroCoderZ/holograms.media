````markdown name=PROJECT_CONTEXT.md
# PROJECT_CONTEXT.md - Контекст Проекта "Голографические Медиа"

## Текущее Состояние Проекта

Проект находится в активной фазе разработки. **Завершена Фаза 1: Миграция базы данных бэкенда с MongoDB на PostgreSQL (с использованием pgvector).** Это создало прочную основу для дальнейшего развития.
**В настоящее время активно ведется Фаза 2, которая фокусируется на реализации системы аутентификации пользователей, управлении учетными записями и создании базовых пользовательских функций.** Это включает сохранение и управление жестами, состояниями голограмм, историей чатов (теперь привязанной к сессиям пользователя) и версионированием промптов.
Параллельно продолжается работа над улучшением фронтенда для отображения 3D-голограмм и интеграции аудио-визуальных элементов. CI/CD через GitHub Actions для деплоя на Hugging Face Spaces настроен и работает.

## Цели Текущей Итерации

**Основные цели текущей итерации (Фаза 2):**
1.  **Завершение интеграции PostgreSQL:** Включая управление учетными записями пользователей.
2.  **Реализация API для пользовательского контента:** Разработка и тестирование эндпоинтов для управления жестами, голограммами, сессиями чата и промптами пользователей.
3.  **Создание безопасной системы аутентификации:** На основе JWT токенов для защиты пользовательских данных и API.
4.  **Актуализация проектной документации:** (`PROJECT_CONTEXT.md`, `ARCHITECTURE.md`, `tria_memory_buffer.md`) для отражения новой архитектуры бэкенда и API.

### 3. Критические Проблемы (Блокеры)

*   **Фокус на бэкенде:** На данный момент основные усилия сосредоточены на завершении Фазы 2 бэкенда. Критических проблем, блокирующих эту фазу, не выявлено, но требуется тщательное тестирование новых API.
*   **Фронтенд:** После завершения Фазы 2 бэкенда потребуется интеграция новых API на стороне фронтенда.
*   ~~**[КРИТИЧЕСКАЯ ПРОБЛЕМА]** `Uncaught SyntaxError: Export 'animate' is not defined in module (at rendering.js:420:23)` (Лог HF Spaces от 2025-05-25 00:35:07) - **Блокирует отображение 3D сцены.** Требует немедленного исправления экспорта/импорта `animate` в `rendering.js` и его вызова.~~ (ИСПРАВЛЕНО 2025-05-25)
*   **УСТРАНЕНО (Frontend):** Множественные JavaScript ошибки, связанные с загрузкой модулей, импортами, инициализацией UI и 3D-сцены, были исправлены в предыдущих итерациях.
*   **УСТРАНЕНО:** Критические ошибки бэкенда в `backend/app.py` (`SyntaxError`, `IndentationError`).
*   **УСТРАНЕНО:** Ошибки загрузки модулей (`404 Not Found` для `ui.js`).
*   **УСТРАНЕНО:** Ошибка `GET .../static/js/panels/panelManager.js net::ERR_ABORTED 404` (исправлен путь импорта в `events.js`).
*   **УСТРАНЕНО:** Ошибки дублирования экспортов (`Duplicate export` в `panelManager.js`).
*   **УСТРАНЕНО:** Ошибки `Runtime Error` (связанные с инициализацией сцены, поиском DOM-элементов, инициализацией аудио плеера и панелей).
*   **УСТРАНЕНО:** Ошибка `SyntaxError: Invalid or unexpected token` в `rendering.js` после мержа.
*   **УСТРАНЕНО:** `ReferenceError` для `toggleChatMode` и `updateHologramLayout` в `events.js` (добавлены необходимые импорты).
*   **УСТРАНЕНО:** Ошибка `SyntaxError: missing ) after argument list` (или `Unexpected token TWEEN`) в `rendering.js` (строка ~395).
*   **УСТРАНЕНО:** `Uncaught TypeError: Failed to resolve module specifier "@tweenjs/tween.js"` ✅ ИСПРАВЛЕНО (2025-05-25)
*   **РЕАЛИЗОВАНО:** Базовая логика аудиовизуализации из `script.js.bak` интегрирована в `rendering.js` и `audioProcessing.js`.
- **Frontend: Fixing Tween.js import error for 3D launch**
  - **Статус:** Завершено.
  - **Описание:** Исправлена ошибка импорта `Tween.js` в `rendering.js` путем удаления ES6 импорта и использования глобальной переменной, загружаемой через CDN. Устранены ошибки ESLint, связанные с неопределенными переменными `camera` и `renderer` путем использования `state.camera` и `state.renderer`. Закомментирован неиспользуемый импорт `getSemitoneLevels`. Удален неиспользуемый параметр `time` из `updateHologramMesh`. Изменения зафиксированы и отправлены в репозитории GitHub и Hugging Face. Обнаружена критическая уязвимость на GitHub (требует дальнейшего анализа).
- **Frontend: Финальная отладка `rendering.js` (экспорт onWindowResize)**
  - **Статус:** Завершено.
  - **Описание:** Исправлена ошибка экспорта `onWindowResize` в `rendering.js` путем удаления его из списка экспорта, так как функция была удалена ранее. Это устраняет `Uncaught SyntaxError: Export 'onWindowResize' is not defined in module`.
- **Frontend: Fixing ReferenceError and SyntaxError**
  - **Статус:** Завершено.
  - **Описание:** Устранена ошибка `ReferenceError: Cannot access 'state' before initialization` в `frontend/js/3d/rendering.js` путем удаления дублирующей функции `onWindowResize`. Исправлена ошибка `SyntaxError: Unexpected token ')'` в `frontend/js/audio/microphoneManager.js` путем добавления отсутствующей закрывающей скобки. Изменения будут зафиксированы и отправлены в репозитории GitHub и Hugging Face.
*   **СЛЕДУЮЩИЕ ШАГИ:** Продолжение работы над UI, интеграция новых типов голограмм, проектирование схемы базы данных PostgreSQL.

## Последние Изменения и Прогресс

*   **[Дата Завершения Фазы 1] Фаза 1 Завершена: Успешно мигрирована база данных бэкенда с MongoDB на PostgreSQL с расширением pgvector.** Это включает обновление схемы БД, CRUD операций и конфигурации приложения.
*   **[Дата] Фаза 2: Реализована система аутентификации пользователей.**
    *   Добавлены JWT-токены и хэширование паролей (`backend/auth/security.py`).
    *   Созданы Pydantic модели для пользователей и токенов (`backend/models/user_models.py`, `backend/models/auth_models.py`).
    *   Реализованы API эндпоинты для регистрации, входа и получения информации о текущем пользователе (`backend/routers/auth.py` - `/auth/register`, `/auth/token`, `/users/me`).
*   **[Дата] Фаза 2: Расширена схема PostgreSQL и CRUD операции.**
    *   Добавлены таблицы для хранения пользовательских данных: `user_gestures`, `user_holograms`, `user_chat_sessions`, `user_prompt_versions`.
    *   Обновлены таблицы `users` (добавлены роли, статус, настройки) и `chat_history` (теперь связана с `user_chat_sessions`).
    *   Реализованы CRUD операции для всех новых таблиц (`backend/db/crud_operations.py`).
*   **[Дата] Фаза 2: Разработаны API роутеры для пользовательских функций.**
    *   `backend/routers/gestures.py`: CRUD для пользовательских жестов.
    *   `backend/routers/holograms.py`: CRUD для сохраненных состояний голограмм пользователя.
    *   `backend/routers/chat_sessions.py`: Управление сессиями чата и сообщениями, заменяя старые общие эндпоинты чата.
    *   `backend/routers/prompts.py`: CRUD для версий пользовательских промптов.
*   **[Дата] Фаза 2: Реализовано начальное заполнение базы данных пользователями.**
    *   Добавлена функция `create_initial_users` для создания администратора и тестового пользователя при старте приложения (на основе переменных окружения).
*   [2025-05-25] Исправлен импорт Tween.js и ошибки ESLint в `rendering.js`.
*   [2025-05-25] Исправлена функция `animate` в `frontend/js/3d/rendering.js` для корректного запуска цикла рендеринга 3D-сцены. Обеспечен ее правильный экспорт и импорт в `main.js`.
*   [2025-05-25] Исправлена ошибка экспорта `onWindowResize` в `rendering.js`.
*   [2025-05-25] Исправлены критические ошибки в `backend/app.py` (`SyntaxError`, `IndentationError`).
*   [2025-05-25] Исправлена IndentationError (unexpected indent) в backend/app.py.
*   [2025-05-23] Исправлены ошибки `404 Not Found` для `ui.js` и `Duplicate export` в `panelManager.js`.
*   [2025-05-23] Устранены множественные `Runtime Error`, связанные с инициализацией сцены, UI элементов (панелей, аудио плеера) и обработчиков событий DOM.
*   [2025-05-23] Актуализированы `index.html` для корректной структуры UI.
*   [2025-05-23] Разрешены конфликты слияния в контекстных файлах и коде.
*   [2025-05-24] Исправлена финальная SyntaxError в rendering.js (стр.395) и реализована базовая аудиовизуализация.

### 2.2. Последние ключевые изменения в коде (за последние 1-2 итерации):

*   **Бэкенд:** Основные изменения связаны с миграцией на PostgreSQL, реализацией аутентификации и CRUD операций для пользовательских данных (жесты, голограммы, чаты, промпты). Структура бэкенда была реорганизована с использованием FastAPI роутеров для лучшей модульности.
*   **Фронтенд:** [2025-05-25] Исправлен импорт Tween.js и ошибки ESLint в `rendering.js`. Обеспечен корректный запуск цикла рендеринга 3D-сцены.
*   [2025-05-25] Исправлена функция `animate` в `frontend/js/3d/rendering.js` для корректного запуска цикла рендеринга 3D-сцены. Обеспечен ее правильный экспорт и импорт в `main.js`.
*   [2025-05-25] Исправлена ошибка экспорта `onWindowResize` в `rendering.js`.
*   [2025-05-25] Исправлены критические ошибки в `backend/app.py` (`SyntaxError`, `IndentationError`).

## Архитектура и Модули (Кратко)

Проект использует модульную структуру.
*   **Бэкенд:**
    *   **База данных:** PostgreSQL с расширением pgvector.
    *   **API:** FastAPI.
    *   **Аутентификация:** JWT-токены (`backend/auth/security.py`).
    *   **Модели данных:** Pydantic модели в `backend/models/` (включая `user_models.py`, `auth_models.py`, `gesture_models.py`, `hologram_models.py`, `chat_models.py`, `prompt_models.py`).
    *   **Операции с БД (CRUD):** `backend/db/crud_operations.py`.
    *   **API Роутеры:** Модули в `backend/routers/` (включая `auth.py`, `gestures.py`, `holograms.py`, `chat_sessions.py`, `prompts.py`).
*   **Фронтенд:**
    *   `frontend/js/core`: Основная логика инициализации, событий, состояния.
    *   `frontend/js/3d`: Работа с Three.js/WebGPU, рендеринг, управление сценой и объектами.
    *   `frontend/js/ui`: Управление пользовательским интерфейсом (панели, элементы управления).
    *   `frontend/js/audio`: Работа с Web Audio API, управление аудио источниками и анализом.

(Более детально в `ARCHITECTURE.md` и `MODULE_CATALOG.md`)

## СЛЕДУЮЩИЕ ШАГИ

*   **Интеграция Фронтенда:** Подключение фронтенда к новым API бэкенда для аутентификации пользователей и управления пользовательскими данными (жесты, голограммы, история чатов, промпты).
*   **Развитие Триа:** Дальнейшая разработка и обучение ботов Триа с использованием персонализированных данных пользователей.
*   **Тестирование:** Комплексное тестирование новых функций бэкенда и их интеграции с фронтендом.
*   **Документация:** Финальная актуализация всей проектной документации по завершении Фазы 2.

## Среда Разработки и Деплой

*   **Локально:** Разработка ведется в Trae AI IDE.
*   **Удаленный репозиторий:** GitHub (`github main`).
*   **CI/CD:** GitHub Actions для автоматического деплоя на Hugging Face Spaces при каждом push в `main`.
*   **Деплой:** Hugging Face Spaces (https://huggingface.co/spaces/NeuroCoderZ/holograms-media).

## Команда

*   **НейроКодер (Александр):** Руководитель проекта, основной разработчик, постановщик задач.
*   **AI-ассистент NeuroCoderZ (Ты):** Эксперт по коду, помощник в рефакторинге, отладке, написании кода и актуализации документации.
*   **Jules:** Разработчик аудио подсистемы (Web Audio API, анализаторы).

---

*Последнее обновление: 2025-05-25*
````