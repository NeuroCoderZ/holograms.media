> **[ВАЖНО]** Этот документ описывает концептуальные, исследовательские или плановые материалы. Он **не описывает** текущую, внедренную архитектуру проекта. Для получения точного описания действующей системы, пожалуйста, обратитесь к файлу `docs/RU/Architecture/SystemDescription.md`.

# Исследование альтернативных PaaS для Python бэкенда и хранения файлов

**Дата исследования:** 2024-07-26
**Исполнитель:** Flash (Исследовательская задача Batch Tau)

## 1. Введение

Задача заключалась в поиске и анализе альтернативных **полностью бесплатных (без обязательной привязки банковской карты для старта)** PaaS-платформ для хостинга Python/FastAPI бэкенда и хранения файлов "чанков". Платформа должна поддерживать подключение к внешней PostgreSQL (Neon.tech) и использование Firebase Admin SDK.

## 2. Ключевые требования к платформе

1.  **Поддержка Python/FastAPI** (или Docker).
2.  **Полностью бесплатный стартовый тир БЕЗ ОБЯЗАТЕЛЬНОЙ ПРИВЯЗКИ БАНКОВСКОЙ КАРТЫ.**
3.  HTTP Эндпоинты.
4.  Возможность подключения к внешней PostgreSQL (Neon.tech).
5.  Возможность использовать `firebase-admin` SDK (установка через `requirements.txt`).
6.  Переменные окружения.
7.  **Хранение файлов "чанков"**: Либо встроенное, либо легко интегрируемое бесплатное объектное хранилище (без карты).
8.  **Геополитическая доступность для России** (отсутствие явных ограничений).

## 3. Исследованные платформы

Были исследованы следующие платформы:

*   Render.com
*   Fly.io
*   PythonAnywhere.com
*   Cloudflare R2 (как опция для хранения файлов)

Backblaze B2 не удалось исследовать из-за ограничений `robots.txt` на их сайте.

### 3.1. Render.com

| Требование                               | Соответствие и комментарии                                                                                                |
| :--------------------------------------- | :------------------------------------------------------------------------------------------------------------------------ |
| **1. Python/FastAPI (Docker)**         | **Да**. Поддерживает нативные рантаймы Python и Docker.                                                                     |
| **2. Бесплатный тир БЕЗ КАРТЫ**        | **Да, для старта**. Карта не требуется для регистрации и использования Free Web Service. Однако, карта потребуется для оплаты превышения лимитов (трафик, время сборки), иначе сервисы будут приостановлены. |
| **3. HTTP Эндпоинты**                   | **Да**.                                                                                                                    |
| **4. Подключение к внешней PostgreSQL** | **Да**. Free Web Services могут устанавливать исходящие TCP-соединения.                                                       |
| **5. `firebase-admin` SDK**              | **Да**. Установка через `requirements.txt`, доступ к Google API для SDK должен работать.                                      |
| **6. Переменные окружения**             | **Да**.                                                                                                                    |
| **7. Хранение файлов (бесплатно)**      | **Нет**. Persistent Disks платные ($0.25/GB/мес) и не доступны для Free Web Services.                                         |
| **8. Доступность для РФ**               | Явных ограничений нет. Оплата платных услуг или превышений картами РФ может быть невозможна из-за санкций платежных систем. |

**Политика по Free Tier и карте (Render.com):**
*   **Web Services (Free):** 512MB RAM, 0.1 CPU (общий), автоматический spin down после 15 минут неактивности (пробуждение с задержкой). 750 бесплатных инстанс-часов в месяц на аккаунт. 100GB/мес трафика и 500 мин/мес сборки включены.
*   **PostgreSQL (Free):** 1GB хранилища, 256MB RAM. **Критическое ограничение: срок жизни бесплатной базы данных – 30 дней.** После этого она становится недоступной и удаляется через 14 дней, если не переведена на платный тариф.
*   **Карта:** Не требуется для регистрации. Нужна для предотвращения приостановки сервисов при превышении бесплатных лимитов.

**Ограничения Free Tier (Render.com):**
*   Для Web Services: лимиты по RAM/CPU, spin down, нет Persistent Disks, нет SSH-доступа из дашборда, нет масштабирования за пределы одного инстанса.
*   Для PostgreSQL: **30-дневный срок жизни делает его непригодным для постоянного MVP.**

**Способ деплоя (Render.com):**
*   Через Git (подключение к репозиторию GitHub/GitLab/Bitbucket).
*   Через `render.yaml` файл для декларативной конфигурации сервисов.
*   Поддержка развертывания Docker-образов.

**Плюсы для нас (Render.com):**
*   Позволяет стартовать **без карты**.
*   Хорошая поддержка Python/FastAPI через Docker или нативные рантаймы.
*   **Позволяет подключаться к внешней PostgreSQL (Neon.tech).**
*   Поддерживает `firebase-admin` SDK и переменные окружения.
*   Удобная система деплоя.

**Минусы для нас (Render.com):**
*   **Отсутствие бесплатного встроенного хранилища файлов "чанков".**
*   Бесплатный PostgreSQL от Render непригоден из-за 30-дневного лимита.
*   Карта потребуется при любом существенном использовании (превышение лимитов).

**Сложности для разработчиков из России (Render.com):**
*   Потенциальные проблемы с оплатой картами банков РФ, если потребуется перейти на платный тариф или оплачивать превышения.

### 3.2. Fly.io

| Требование                               | Соответствие и комментарии                                                                                               |
| :--------------------------------------- | :----------------------------------------------------------------------------------------------------------------------- |
| **1. Python/FastAPI (Docker)**         | **Да**. Ориентирован на Docker, что отлично подходит для FastAPI.                                                          |
| **2. Бесплатный тир БЕЗ КАРТЫ**        | **Нет**. "All organizations (except for Linked Organizations) require a credit card on file." Бесплатные ресурсы ("Legacy Free allowances") только для старых планов, не для новых пользователей. |
| **3. HTTP Эндпоинты**                   | **Да**.                                                                                                                   |
| **4. Подключение к внешней PostgreSQL** | **Да**.                                                                                                                   |
| **5. `firebase-admin` SDK**              | **Да** (внутри Docker-контейнера).                                                                                        |
| **6. Переменные окружения**             | **Да** (через Secrets).                                                                                                   |
| **7. Хранение файлов (бесплатно)**      | **Нет**. Fly Volumes платные ($0.15/GB/мес). "Legacy Free allowances" (3GB) не для новых пользователей.                     |
| **8. Доступность для РФ**               | Требование международной карты само по себе проблема. Дополнительных явных ограничений не найдено.                       |

**Политика по Free Tier и карте (Fly.io):**
*   **Карта обязательна для регистрации новой организации.**
*   Актуального бесплатного стартового тира для новых пользователей нет, только модель "Pay As You Go". Самые маленькие инстансы платные (например, shared-cpu-1x 256MB RAM ~ $1.94/месяц).

**Ограничения Free Tier (Fly.io):**
*   Неприменимо для новых пользователей.

**Способ деплоя (Fly.io):**
*   Через CLI `flyctl` и деплой Docker-образов. Конфигурация через `fly.toml`.

**Плюсы для нас (Fly.io):**
*   Мощная и гибкая платформа, глобальное распределение.
*   Хороший контроль над машинами (VM).

**Минусы для нас (Fly.io):**
*   **Требование банковской карты для регистрации (блокирующий фактор).**
*   **Отсутствие бесплатного тира для новых пользователей.**
*   Платное хранилище.

**Сложности для разработчиков из России (Fly.io):**
*   Обязательное требование работающей международной банковской карты.

### 3.3. PythonAnywhere.com

| Требование                               | Соответствие и комментарии                                                                                                                              |
| :--------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **1. Python/FastAPI (Docker)**         | Python - **Да**. FastAPI (ASGI) - **под вопросом на Free tier** (вероятно, потребуется WSGI-фреймворк или WSGI-ASGI мост). Docker - **Нет**.                   |
| **2. Бесплатный тир БЕЗ КАРТЫ**        | **Да**. Тариф "Beginner" полностью бесплатный и не требует карты.                                                                                         |
| **3. HTTP Эндпоинты**                   | **Да** (на поддомене `your-username.pythonanywhere.com` для Free tier).                                                                                 |
| **4. Подключение к внешней PostgreSQL** | **Нет на Free tier**. Исходящий интернет-доступ ограничен HTTP/S к сайтам из whitelist. Прямые TCP-соединения к внешним БД невозможны. Да на платных тарифах. |
| **5. `firebase-admin` SDK**              | **Вероятно, да на Free tier**. Многие домены Google (`googleapis.com`, `firebaseio.com`) находятся в whitelist.                                        |
| **6. Переменные окружения**             | **Да**.                                                                                                                                                 |
| **7. Хранение файлов (бесплатно)**      | **Да**. Тариф "Beginner" включает **512MB** дискового пространства.                                                                                        |
| **8. Доступность для РФ**               | Для Free tier проблем нет. Для платных - возможны проблемы с оплатой картами РФ.                                                                           |

**Политика по Free Tier и карте (PythonAnywhere.com):**
*   **Beginner (Free):** 1 веб-приложение, 100 CPU-секунд/день для консолей и задач (веб-приложения имеют отдельный лимит на 1 web worker), 512MB диска, ограниченный интернет (только HTTP/S к whitelist), 1 ежедневная задача по расписанию, нет always-on tasks, нет SSH. Карта не требуется.

**Ограничения Free Tier (PythonAnywhere.com):**
*   **Критично: невозможность подключения к внешней PostgreSQL (Neon.tech) на бесплатном тарифе.**
*   Потенциальные сложности с запуском FastAPI (ASGI) без WSGI-моста.
*   Низкие лимиты CPU.

**Способ деплоя (PythonAnywhere.com):**
*   Загрузка кода через веб-интерфейс. Настройка веб-приложения (WSGI-файл) через UI.

**Плюсы для нас (PythonAnywhere.com):**
*   **Полностью бесплатный старт без карты.**
*   **Предоставляет 512MB диска для хранения файлов "чанков".**
*   Вероятная работа `firebase-admin` SDK.
*   Простота для Python-разработчиков.

**Минусы для нас (PythonAnywhere.com):**
*   **Невозможность подключения к внешней PostgreSQL (Neon.tech) на бесплатном тарифе (блокирующий фактор).**
*   Сложности или невозможность прямого запуска FastAPI (ASGI) на бесплатном тарифе.

**Сложности для разработчиков из России (PythonAnywhere.com):**
*   Для бесплатного тарифа - нет.

### 3.4. Cloudflare R2 (как опция для хранения файлов)

| Требование                               | Соответствие и комментарии                                                                                                                              |
| :--------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **1. Python/FastAPI (Docker)**         | Неприменимо (это объектное хранилище). Интегрируется с бэкендом через S3 API.                                                                           |
| **2. Бесплатный тир БЕЗ КАРТЫ**        | **Вероятно, нет**. Cloudflare обычно требует карту для активации аккаунта, даже для доступа к бесплатным сервисам. Точная информация конкретно для R2 Free Tier без общей привязки карты не найдена, но маловероятна. |
| **3. HTTP Эндпоинты (для файлов)**      | **Да**.                                                                                                                                                 |
| **4. Подключение к внешней PostgreSQL** | Неприменимо.                                                                                                                                            |
| **5. `firebase-admin` SDK**              | Неприменимо.                                                                                                                                            |
| **6. Переменные окружения (для доступа)**| **Да** (ключи доступа для R2 будут храниться в переменных окружения бэкенда).                                                                           |
| **7. Хранение файлов (бесплатно)**      | **Да, очень щедрый тариф:** 10 GB-month хранения, 1 миллион Class A операций/месяц, 10 миллионов Class B операций/месяц. **Egress (исходящий трафик) полностью бесплатный.** |
| **8. Доступность для РФ**               | Сам сервис Cloudflare доступен. Если требуется карта для регистрации, это будет проблемой.                                                                 |

**Политика по Free Tier и карте (Cloudflare R2):**
*   **Free Tier:** 10 ГБ хранилища, 1М Class A, 10М Class B операций, бесплатный egress.
*   **Карта:** Вероятно, требуется для создания аккаунта Cloudflare.

**Плюсы для нас (Cloudflare R2):**
*   **Отличный бесплатный тариф для хранения файлов (10GB).**
*   **Полностью бесплатный исходящий трафик.**
*   S3-совместимый API, простая интеграция (например, с `boto3`).

**Минусы для нас (Cloudflare R2):**
*   **Вероятное требование банковской карты для регистрации аккаунта (потенциальный блокирующий фактор).**

**Сложности для разработчиков из России (Cloudflare R2):**
*   Если карта обязательна, это создаст сложности.

## 4. Сравнительный анализ и Рекомендация

Ни одна из исследованных PaaS-платформ не удовлетворяет одновременно всем строгим требованиям (бесплатный старт без карты, поддержка внешней PostgreSQL, бесплатное хранение файлов).

*   **Fly.io** отпадает из-за обязательного требования карты.
*   **PythonAnywhere.com** отпадает из-за невозможности подключения к внешней PostgreSQL на бесплатном тарифе.

**Render.com** является наиболее подходящим кандидатом для хостинга **Python/FastAPI бэкенда**:
*   **Преимущества:** Позволяет стартовать без карты, поддерживает Python/Docker, обеспечивает подключение к внешней PostgreSQL (Neon.tech) и работу `firebase-admin` SDK.
*   **Недостаток:** Отсутствует бесплатное встроенное хранилище файлов на бесплатном тарифе.

**Cloudflare R2** является идеальным кандидатом для **хранения файлов "чанков"** с точки зрения характеристик бесплатного тарифа (10GB, бесплатный egress).
*   **Недостаток:** Вероятное требование банковской карты для регистрации аккаунта Cloudflare.

**Рекомендация:**

1.  **Для хостинга бэкенда (FastAPI):** Использовать **Render.com (Free Web Service)**.
    *   Это позволит развернуть приложение, подключиться к Neon.tech и Firebase Admin SDK без немедленной необходимости привязки карты.
    *   Необходимо учитывать, что при превышении бесплатных лимитов Render (трафик, время сборки) потребуется карта для продолжения работы сервиса.

2.  **Для хранения файлов "чанков":**
    *   **Вариант А (если требование "без карты" абсолютно для всего):** Необходимо провести **дополнительное исследование** на предмет существования объектных хранилищ с бесплатным тарифом, не требующих карту для регистрации. Если такие не будут найдены, это станет серьезным блокером для текущей постановки задачи.
    *   **Вариант Б (если можно допустить карту для хранилища, но не для PaaS бэкенда):** Использовать **Cloudflare R2**. Его бесплатный тариф (10GB, бесплатный egress) отлично подходит. Однако, это нарушит строгое требование "без карты".
    *   **Вариант В (компромиссный, если внешнее хранилище не найдено/не подходит):** Временно (на самом раннем этапе MVP) рассмотреть хранение небольшого объема чанков непосредственно на временном хранилище инстанса Render (если оно есть и доступно для записи, что маловероятно для долгосрочного или надежного хранения) или отказаться от хранения файлов до выбора подходящего хранилища. Это плохой вариант, но возможный, если другие не реализуемы. **Более реалистичный компромисс тут - отказаться от бесплатности хранилища и заложить минимальный бюджет, либо отказаться от требования "без карты" для хранилища.**

**Заключение по рекомендации:**
Наиболее жизнеспособной стратегией, максимально приближенной к требованиям, является использование **Render.com для бэкенда**. Вопрос хранения файлов требует либо дополнительного поиска решения "без карты", либо пересмотра этого конкретного требования для компонента хранения.

## 5. Описание процессов для рекомендованной платформы (Render.com + Cloudflare R2)

**(A) Render.com для FastAPI бэкенда**

**1. Инициализация Firebase Admin SDK в FastAPI на Render.com**

*   **Переменные окружения:**
    *   Содержимое JSON файла сервисного ключа Firebase кодируется в Base64 и сохраняется в переменной окружения `FIREBASE_SERVICE_ACCOUNT_BASE64` на Render.com.
*   **Код инициализации в FastAPI (пример):**
    ```python
    # main.py
    import firebase_admin
    from firebase_admin import credentials
    import base64
    import json
    import os

    firebase_service_account_base64 = os.getenv("FIREBASE_SERVICE_ACCOUNT_BASE64")
    if firebase_service_account_base64:
        try:
            decoded_service_account = base64.b64decode(firebase_service_account_base64)
            service_account_info = json.loads(decoded_service_account)
            cred = credentials.Certificate(service_account_info)
            firebase_admin.initialize_app(cred)
            print("Firebase Admin SDK инициализирован.")
        except Exception as e:
            print(f"Ошибка инициализации Firebase Admin SDK: {e}")
    # ...
    ```
*   **`requirements.txt`:** Должен содержать `firebase-admin`.

**(B) Взаимодействие FastAPI (на Render.com) с Cloudflare R2 (для хранения чанков)**

*   **Переменные окружения на Render.com для R2:**
    *   `R2_ACCESS_KEY_ID`
    *   `R2_SECRET_ACCESS_KEY`
    *   `R2_ACCOUNT_ID` (для формирования endpoint URL: `https://<ACCOUNT_ID>.r2.cloudflarestorage.com`)
    *   `R2_BUCKET_NAME`
*   **Библиотека:** `boto3` (добавить в `requirements.txt`).
*   **FastAPI эндпоинт для загрузки чанка (пример):**
    ```python
    # main.py
    from fastapi import FastAPI, File, UploadFile, HTTPException
    import boto3
    # ... (импорты и код инициализации Firebase, R2 клиента) ...

    app = FastAPI()

    # Настройка клиента boto3 для R2
    # ... (код инициализации s3_client как в предыдущих примерах) ...

    @app.post("/upload-chunk/")
    async def upload_chunk_endpoint(file: UploadFile = File(...)):
        if not s3_client:
            raise HTTPException(status_code=500, detail="Сервис хранения не настроен.")
        try:
            file_key = f"chunks/{file.filename}" # Уникальное имя файла в R2
            s3_client.upload_fileobj(file.file, R2_BUCKET_NAME, file_key)
            # Опционально: вернуть URL файла, если он публичный или сгенерировать presigned URL
            return {"message": "Chunk uploaded successfully", "r2_key": file_key}
        except Exception as e:
            raise HTTPException(status_code=500, detail=f"Could not upload chunk: {str(e)}")
    ```
*   **Фронтенд:** Отправляет `multipart/form-data` POST-запрос на эндпоинт `/upload-chunk/`.

## 6. Сложности для разработчиков из России

*   **Оплата:** Основная сложность для всех рассмотренных платных опций или при превышении бесплатных лимитов – это оплата с использованием банковских карт, выпущенных в РФ. Международные платежные системы (Visa, Mastercard) ограничили свою работу в России. Это может сделать невозможным переход на платные тарифы или оплату дополнительных услуг.
*   **Доступность сервисов:** На момент исследования явных блокировок доступа к самим платформам (Render, PythonAnywhere, Cloudflare) для пользователей из России не наблюдалось. Однако ситуация может меняться.

## 7. Заключение

Полностью удовлетворить все требования задачи (PaaS без карты, хранилище без карты, внешний PostgreSQL, Firebase SDK) одной или комбинацией исследованных платформ без компромиссов затруднительно. **Render.com** предлагает лучший компромисс для хостинга бэкенда. **Cloudflare R2** идеален для хранения файлов, но, вероятно, требует карту. Если требование "без карты" для хранилища абсолютно, потребуется дополнительный поиск специализированных сервисов хранения.

```markdown
## Тестирование Backblaze B2 (05.06.2025)

### Интеграция
- Код добавлен в `backend/app.py` с использованием `boto3`.
- Переменные окружения настроены в Koyeb: `B2_ACCESS_KEY_ID`, `B2_SECRET_ACCESS_KEY`, `B2_ENDPOINT_URL`.
- В `backend/app.py` добавлена функция `upload_chunk_async` для загрузки чанков и эндпоинт `/upload-chunk`.
- В `backend/app.py` добавлена вспомогательная функция `verify_chunk` для проверки целостности загруженных данных.

### Результаты тестирования
- Успешная загрузка тестового "чанка" `test-chunk-001`. (Ожидается подтверждение пользователем)
- Содержимое файла совпадает с исходным `test_chunk.txt`. (Ожидается подтверждение пользователем)
- Логи Koyeb: [вставьте скриншот или текст логов]. (Будет заполнено пользователем)
- Скриншот бакета B2: [вставьте скриншот бакета с файлом]. (Будет заполнено пользователем)

### Рекомендации
- Мониторить лимиты B2 (10 ГБ, 1 ГБ/день).
- Добавить обработку ошибок для случаев превышения лимитов в клиентском коде или на уровне API-шлюза, если применимо.
- Рассмотреть возможность использования presigned URLs для загрузки напрямую с клиента, если это соответствует архитектуре безопасности.
```
