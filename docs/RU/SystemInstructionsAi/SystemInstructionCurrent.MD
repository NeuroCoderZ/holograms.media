# Текущая Системная Инструкция для AI Агента Проекта "Голографические Медиа"

**Версия Документа:** 2.1
**Дата Актуализации:** 2024-08-01

## 1. Общее Описание Проекта и Цели

Проект "Голографические Медиа" (holograms.media) направлен на создание инновационной мультимодальной платформы для взаимодействия человека с информацией и искусственным интеллектом (AI "Триа") через динамические 3D-аудиовизуализации ("голограммы").

**Ключевые Цели:**
*   Разработка интуитивно понятного интерфейса, объединяющего визуальные, аудио и жестовые модальности.
*   Создание AI-ассистента "Триа", способного к самообучению и адаптации.
*   Преодоление традиционных коммуникационных барьеров.
*   Формирование нового языка коммуникации человек-AI.

**Текущий Статус (MVP):**
Проект находится в активной фазе разработки MVP. Основное внимание уделяется стабилизации ключевых компонентов, реализации основного цикла взаимодействия пользователя с системой, и внедрению продвинутой системы жестового управления. Детали текущего спринта и задач MVP см. в `docs/RU/ProjectOverview/ProjectContext.md` и соответствующих планах.

## 2. Утвержденная Архитектура Проекта

Пожалуйста, **строго придерживайся** следующей архитектуры при анализе, разработке и предоставлении рекомендаций. Любые отклонения или упоминания устаревших компонентов должны быть исправлены в соответствии с этой утвержденной архитектурой.

*   **Frontend (Клиентская часть):**
    *   **Технологии:** Чистый JavaScript (ES6 Modules), HTML5, CSS3. **Без фреймворков.**
    *   **3D-Рендеринг:** Three.js / WebGL.
    *   **Аудиоанализ (клиентский):** Web Audio API, кастомный CWT-анализатор (Continuous Wavelet Transform) на Rust, скомпилированный в WebAssembly (WASM) и интегрированный через AudioWorklet (`frontend/js/audio/waveletAnalyzer.js`, `frontend/js/wasm/fastcwt/`).
    *   **Жестовое Распознавание (клиентское):**
        *   MediaPipe Hands для получения координат ключевых точек рук (`frontend/js/multimodal/handsTracking.js`).
        *   `AtomicGestureClassifier.js` для классификации статических ("атомарных") жестов на основе данных MediaPipe.
        *   `GestureSequencer.js` для распознавания последовательностей атомарных жестов с использованием конечных автоматов (FSM), что позволяет формировать команды.
    *   **Хостинг:** Firebase Hosting.
    *   **Аутентификация (клиентская часть):** Firebase Authentication SDK.
*   **Backend (Основной API и AI "Триа"):**
    *   **Технологии:** Python 3.11+ с использованием FastAPI.
    *   **Хостинг:** Koyeb.
    *   **Контейнеризация:** Docker.
*   **AI Оркестрация (Серверная часть):**
    *   **Основной Инструмент:** **Genkit (на базе Firebase)**. Genkit используется для построения и управления AI-потоками (flows), координации вызовов к LLM, управления контекстом и выполнения сложной AI-логики.
    *   **Интеграция:** Genkit flows интегрируются и вызываются из FastAPI бэкенда. FastAPI обрабатывает HTTP-запросы, аутентификацию, взаимодействие с БД и хранилищем, а для AI-задач обращается к Genkit.
*   **База Данных:**
    *   **Тип:** PostgreSQL (версия, поддерживающая pgvector).
    *   **Хостинг:** Neon.tech.
    *   **Расширения:** `pgvector` для семантического поиска и RAG (Retrieval-Augmented Generation).
*   **Хранилище Файлов ("Чанков" - медиаданные пользователя):**
    *   **Сервис:** Cloudflare R2 (S3-совместимое объектное хранилище).
    *   **Доступ:** Загрузка и управление файлами осуществляются **исключительно** через FastAPI бэкенд на Koyeb.
*   **Аутентификация (серверная часть):**
    *   **Сервис:** Firebase Authentication.
    *   **Проверка токенов:** Firebase Admin SDK используется на FastAPI бэкенде (Koyeb) для верификации JWT токенов пользователей.
*   **Вспомогательные Облачные Функции (Auxiliary Cloud Functions):**
    *   **Сервис:** Firebase Cloud Functions (Python).
    *   **Назначение:** Используются для задач, тесно связанных с событиями Firebase (например, триггеры Firebase Auth).
    *   **Важно:** Основная API-логика и AI-вычисления "Триа" (через Genkit) выполняются на **FastAPI (Koyeb)**.

**Особое Внимание:** При анализе или генерации документации/кода, убедись, что все упоминания архитектуры соответствуют вышеизложенному. Ключевые изменения: клиентское распознавание последовательностей жестов и Genkit как основной инструмент оркестрации AI на бэкенде.

## 3. Ключевые Компоненты и Модули (Сокращенный Обзор)

### 3.1. Frontend (`frontend/js/`)
*   **`main.js`**: Точка входа, инициализация, обработчик команд от `GestureSequencer`.
*   **`/core/`**: Ядро (глобальное состояние `state`, инициализация медиа, аутентификация).
*   **`/3d/`**: Логика 3D-сцены (Three.js, рендеринг).
*   **`/audio/`**: Обработка аудио (микрофон, CWT-анализ).
*   **`/multimodal/handsTracking.js`**: Интеграция с MediaPipe Hands, получение координат, передача данных классификатору жестов.
*   **`/gestures/AtomicGestureClassifier.js`**: Классификация отдельных статических жестов (FIST, OPEN_PALM и т.д.) по данным от MediaPipe.
*   **`/gestures/GestureSequencer.js`**: Распознавание последовательностей атомарных жестов (FSM) и генерация команд.
*   **`/config/gestureSequences.js`**: Конфигурация последовательностей жестов и соответствующих им команд.
*   **`/ui/`**: UI-компоненты и менеджеры.
*   **`/services/apiService.js`**: Взаимодействие с FastAPI бэкендом.

### 3.2. Backend (FastAPI на Koyeb - `backend/`)
*   **`app.py`**: Точка входа FastAPI.
*   **`/routers/`**: API эндпоинты (включая эндпоинты для команд, полученных от Frontend).
*   **`/core/`**: Общая логика (DB, модели Pydantic, сервисы для R2).
*   **`/flows/` (или аналогичная директория для Genkit):** Определения Genkit flows для AI-логики, вызываемые из FastAPI.
*   **`/tria_bots/`**: Могут содержать специфическую логику для отдельных AI-агентов или функций, используемых в Genkit flows.

## 4. Основные Потоки Данных

### 4.1. Взаимодействие Пользователя с Голограммой (с Учетом Жестов)
1.  **Ввод (Frontend):**
    *   **Жесты:** Камера -> MediaPipe Hands (`handsTracking.js`) -> `AtomicGestureClassifier.js` (классификация атомарного жеста) -> `GestureSequencer.js` (анализ последовательности).
    *   Если последовательность распознана, `GestureSequencer` генерирует событие `command:triggered` с именем команды.
    *   `main.js` обрабатывает это событие и выполняет действие на клиенте (например, создание объекта в 3D-сцене) или отправляет команду на бэкенд.
    *   **Другие вводы:** Голос, текст (обрабатываются соответствующими модулями).
2.  **Аудиовизуализация (Frontend):** Микрофон/файл -> CWT (WASM) -> Обновление 3D-сцены.
3.  **Формирование "Чанка" (Frontend):** Упаковка данных взаимодействия (может включать распознанные жесты/команды).
4.  **Отправка на Бэкенд (FastAPI):**
    *   Медиа-файлы в Cloudflare R2 (через FastAPI).
    *   Команды (включая жестовые), текст, другие данные на эндпоинты FastAPI.
5.  **Обработка (FastAPI + Genkit):**
    *   FastAPI: Валидация JWT, сохранение метаданных в Neon.tech PostgreSQL.
    *   Для AI-задач (например, ответ на сложный вопрос, генерация контента на основе жеста): FastAPI вызывает соответствующий **Genkit flow**.
    *   Genkit Flow: Управляет контекстом, вызывает LLM, выполняет поиск по базе знаний (RAG с использованием Neon.tech + pgvector), координирует другие AI-функции.
6.  **Ответ (FastAPI -> Frontend):** HTTP-response от FastAPI (результат выполнения Genkit flow или другой логики).
7.  **Реакция (Frontend):** Обновление UI/голограммы.

### 4.2. AI Оркестрация с Genkit
*   Genkit flows определяют логику выполнения сложных AI-задач.
*   Flows могут быть триггированы запросами от FastAPI (например, при получении команды от пользователя или для фоновой обработки).
*   Genkit управляет состоянием диалога, интеграцией с различными моделями (LLM, возможно, модели для анализа жестов/изображений в будущем на сервере) и инструментами (например, поиск по векторной базе данных).

## 5. Текущие Цели и Задачи
*   **Интеграция и Тестирование Жестовой Системы:** Полная проверка цепочки от захвата жеста до выполнения команды.
*   **Разработка Базовых Genkit Flows:** Создание первых AI-потоков для обработки команд и взаимодействия с пользователем.
*   **Стабилизация Архитектуры:** Обеспечение надежной работы всех компонентов в новой конфигурации.
*   **Детальные планы и статус задач:** См. `docs/RU/ProjectOverview/ProjectContext.md` и задачи в GitHub.

## 6. Важные Замечания для AI Агента
*   **Приоритет на Актуальную Архитектуру:** Эта инструкция описывает **единственно верную текущую архитектуру**. Обрати особое внимание на роли `AtomicGestureClassifier`, `GestureSequencer` на клиенте и **Genkit** для AI-оркестрации на бэкенде.
*   **Контекст Проекта и Дорожная Карта:** Учитывай `docs/RU/ProjectOverview/ProjectContext.md` и `docs/RU/ProjectOverview/Roadmap.md`.
*   **Язык Документации:** Русский.

Эта инструкция должна служить твоей основной базой знаний о проекте.
