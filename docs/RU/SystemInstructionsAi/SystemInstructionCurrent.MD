# Текущая Системная Инструкция для AI Агента Проекта "Голографические Медиа"

**Версия Документа:** 2.0
**Дата Актуализации:** 2024-07-31

## 1. Общее Описание Проекта и Цели

Проект "Голографические Медиа" (holograms.media) направлен на создание инновационной мультимодальной платформы для взаимодействия человека с информацией и искусственным интеллектом (AI "Триа") через динамические 3D-аудиовизуализации ("голограммы").

**Ключевые Цели:**
*   Разработка интуитивно понятного интерфейса, объединяющего визуальные, аудио и жестовые модальности.
*   Создание AI-ассистента "Триа", способного к самообучению и адаптации.
*   Преодоление традиционных коммуникационных барьеров.
*   Формирование нового языка коммуникации человек-AI.

**Текущий Статус (MVP):**
Проект находится в активной фазе разработки MVP. Основное внимание уделяется стабилизации ключевых компонентов и реализации основного цикла взаимодействия пользователя с системой. Детали текущего спринта и задач MVP см. в `docs/RU/ProjectOverview/ProjectContext.md` и соответствующих планах.

## 2. Утвержденная Архитектура Проекта

Пожалуйста, **строго придерживайся** следующей архитектуры при анализе, разработке и предоставлении рекомендаций. Любые отклонения или упоминания устаревших компонентов должны быть исправлены в соответствии с этой утвержденной архитектурой.

*   **Frontend (Клиентская часть):**
    *   **Технологии:** Чистый JavaScript (ES6 Modules), HTML5, CSS3. **Без фреймворков.**
    *   **3D-Рендеринг:** Three.js / WebGL.
    *   **Аудиоанализ (клиентский):** Web Audio API, кастомный CWT-анализатор (Continuous Wavelet Transform) на Rust, скомпилированный в WebAssembly (WASM) и интегрированный через AudioWorklet (`frontend/js/audio/waveletAnalyzer.js`, `frontend/js/wasm/fastcwt/`).
    *   **Хостинг:** Firebase Hosting.
    *   **Аутентификация (клиентская часть):** Firebase Authentication SDK.
*   **Backend (Основной API и AI "Триа"):**
    *   **Технологии:** Python 3.11+ с использованием FastAPI.
    *   **Хостинг:** Koyeb.
    *   **Контейнеризация:** Docker.
*   **База Данных:**
    *   **Тип:** PostgreSQL (версия, поддерживающая pgvector).
    *   **Хостинг:** Neon.tech.
    *   **Расширения:** `pgvector` для семантического поиска и RAG (Retrieval-Augmented Generation).
*   **Хранилище Файлов ("Чанков" - медиаданные пользователя):**
    *   **Сервис:** Cloudflare R2 (S3-совместимое объектное хранилище).
    *   **Доступ:** Загрузка и управление файлами осуществляются **исключительно** через FastAPI бэкенд на Koyeb. Прямой доступ клиента к R2 не предполагается.
*   **Аутентификация (серверная часть):**
    *   **Сервис:** Firebase Authentication.
    *   **Проверка токенов:** Firebase Admin SDK используется на FastAPI бэкенде (Koyeb) для верификации JWT токенов пользователей.
*   **Вспомогательные Облачные Функции (Auxiliary Cloud Functions):**
    *   **Сервис:** Firebase Cloud Functions (Python).
    *   **Назначение:** Используются для задач, тесно связанных с событиями Firebase (например, триггеры Firebase Auth для синхронизации данных пользователя с основной базой данных PostgreSQL на Neon.tech), или для выполнения легковесных, изолированных вспомогательных операций, если это целесообразно.
    *   **Важно:** Основная API-логика, обработка данных и AI-вычисления "Триа" выполняются на **FastAPI (Koyeb)**.
*   **AI "Триа" (Оркестрация и Модели):**
    *   **Логика и Оркестрация:** Преимущественно на FastAPI бэкенде (Koyeb). Включает модули для различных ботов (`ChatBot`, `GestureBot`, `AudioBot`, `MemoryBot`, `LearningBot`), управляемые `CoordinationService`.
    *   **Модели:** Взаимодействие с внешними LLM API (например, Google Gemini, Mistral).
    *   **Перспектива:** Использование Genkit для более сложной оркестрации AI-логики, интегрированного в FastAPI бэкенд.

**Особое Внимание:** При анализе или генерации документации/кода, убедись, что все упоминания архитектуры соответствуют вышеизложенному. В частности, Cloudflare R2 является текущим S3-совместимым хранилищем (заменив любые упоминания Backblaze B2 или Firebase Storage для чанков). Основной бэкенд – FastAPI на Koyeb.

## 3. Ключевые Компоненты и Модули (Сокращенный Обзор)

Детальное описание модулей см. в `docs/RU/Architecture/ModuleCatalog.MD` и `docs/RU/Architecture/ModuleInterfaces.MD`.

### 3.1. Frontend (`frontend/js/`)
*   **`main.js`**: Точка входа, инициализация.
*   **`/core/`**: Ядро (глобальное состояние `state`, обработчики событий, инициализация медиа, аутентификация Firebase).
*   **`/3d/`**: Логика 3D-сцены (Three.js, рендеринг голограммы, CWT-визуализация).
*   **`/audio/`**: Обработка аудио (микрофон, плеер, CWT-анализ через WASM AudioWorklet).
*   **`/multimodal/`**: Обработка жестов (MediaPipe Hands).
*   **`/ui/`**: UI-компоненты и менеджеры.
*   **`/services/apiService.js`**: Взаимодействие с FastAPI бэкендом на Koyeb.

### 3.2. Backend (FastAPI на Koyeb - `backend/`)
*   **`app.py`**: Точка входа FastAPI.
*   **`/routers/`**: API эндпоинты.
*   **`/core/`**: Общая логика (DB, модели Pydantic, сервисы для LLM, R2).
*   **`/tria_bots/`**: Модули AI "Триа".

### 3.3. Вспомогательные Firebase Cloud Functions (`backend/cloud_functions/`)
*   Изолированные функции для специфических триггеров Firebase (например, `auth_sync`).

## 4. Основные Потоки Данных

### 4.1. Взаимодействие Пользователя с Голограммой
1.  **Ввод (Frontend):** Жесты, голос, текст.
2.  **Аудиовизуализация (Frontend):** Микрофон/файл -> CWT (WASM) -> Обновление 3D-сцены.
3.  **Формирование "Чанка" (Frontend):** Упаковка данных взаимодействия.
4.  **Отправка на Бэкенд (FastAPI):**
    *   Медиа-файлы в Cloudflare R2 (через FastAPI).
    *   Команды/текст на эндпоинты FastAPI.
5.  **Обработка (FastAPI):** Валидация JWT, сохранение метаданных в Neon.tech PostgreSQL, оркестрация ботов "Триа", взаимодействие с LLM.
6.  **Ответ (FastAPI -> Frontend):** HTTP-response.
7.  **Реакция (Frontend):** Обновление UI/голограммы.

### 4.2. Аутентификация
1.  **Frontend:** Firebase Auth UI, получение JWT.
2.  **Frontend -> Backend:** JWT на эндпоинт FastAPI (`/auth/sync`) или Firebase Cloud Function (`auth_sync`).
3.  **Backend:** Валидация токена, синхронизация пользователя с PostgreSQL.

### 4.3. Обучение "Триа"
1.  **Сбор Данных:** Взаимодействия и обратная связь сохраняются в PostgreSQL (через FastAPI).
2.  **LearningBot (FastAPI):** Анализ данных, предложение/тестирование изменений.
3.  **Обновление:** Интеграция успешных изменений.

## 5. Текущие Цели и Задачи (MVP)
*   **Стабилизация Фронтенда:** Надежная аудио-реактивная визуализация и UI на Firebase Hosting.
*   **Надежность Бэкенда:** Тестирование FastAPI на Koyeb, Cloud Functions, обработка ошибок.
*   **Интеграция Сервисов:** Бесшовная работа FastAPI, Cloudflare R2, Firebase (Auth, Hosting, Functions), Neon.tech PostgreSQL.
*   **Детальные планы и статус задач:** См. `docs/RU/ProjectOverview/ProjectContext.md` и задачи в GitHub.

## 6. Важные Замечания для AI Агента
*   **Приоритет на Актуальную Архитектуру:** Эта инструкция описывает **единственно верную текущую архитектуру**.
*   **Контекст Проекта и Дорожная Карта:** Учитывай `docs/RU/ProjectOverview/ProjectContext.md` и `docs/RU/ProjectOverview/Roadmap.md`.
*   **Язык Документации:** Русский.

Эта инструкция должна служить твоей основной базой знаний о проекте.
